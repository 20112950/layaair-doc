# WebGL拼接图片产生缝隙的问题

**在LayaAir引擎中如果渲染模式采用了WebGL，则图片拼接处会经常出现缝隙。如下图所示：**

![1](C:\Users\mengjia\Desktop\WebGL下黑屏\img\1.png)</br>(图1)

### 出现缝隙的原因：

1）3D世界中半个像素的问题；WebGL是采用显卡硬件加速渲染，绘制一张纹理是通过UV和图片的像素值对位的方法，以及WebGL中的寻址方法等。（本篇文章中不再过多解释半个像素的资料，有兴趣的可以去google查下）

2）2D中资源带有缩放或增加缩放的时候，由于精度的问题，这个缝隙出现的会更加明显。

### 引擎中画面处理方式：

在LayaAir引擎中有两种打包图集的方法。一种是直接在UI编辑模式下导出资源，一种是使用工具栏中的图集打包工具进行打包。但是这两种功能都做了同样的事情，把小图合并到图集的时候都增加了保护边，如下图所示：

![2](C:\Users\mengjia\Desktop\WebGL下黑屏\img\2.png)</br>(图2)

**（绿色部分代表最边缘的像素）**

合并到一张大图中位置为100,100。合并到大图中的时候就会自动把最边缘的像素扩充出来，但是真正绘制的时候，还是取100,100的位置。这样就能避免缝隙，如下图所示：

![3](C:\Users\mengjia\Desktop\WebGL下黑屏\img\3.png)</br>(图3)

**（蓝色部分就是扩充出来的边，这个边的像素值就是复制图2中的边缘值）**

### 拼接的地图如何修改？

通过上面讲解的原理，大家应该都理解了。但是很多场景是通过第三方工具拼接的，比如使用了Tiled-Map：

**Tiled-Map没有做这样的保护边，该如何处理呢？**

最简单的方法就是采样的时候各缩小一个像素值，比如场景元素是64*64的格子，那么绘制的代码如下所示：

```typescript
drawImage(image,sx,sy,sw,sh,dx,dy,dw,dh);
```

原本是用以下方式来写的：

```typescript
drawImage(image,128,256,64,64,100,100,64,64);//这种写法就可能会出现缝隙
```

现在则需要改为：

```typescript
drawImage(image,128+1,256+1,64-1,64-1,100,100,64,64);
```

也就是采样的时候把资源缩小一圈，但是绘制的时候，还是64那么大。大部分这种处理方法是看不出来的（大多数游戏就是这样处理的）。

但是如果想要更好的效果，则需要美术下点功夫，比如绘制图片元素的时候，就已经把保护边给绘制好。









