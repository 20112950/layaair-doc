# LayaDCC tool

## Introduction
LayaDCC：Laya-Dynamic Content Check，a hot update solution provided by LayaPlayer. The advantage is that the network traffic can be reduced effectively when the running difference is updated. main data is DCC file, DCC file is used to describe the check value of all files in the project. DCC file is generated by the tool layadcc.

Layadcc will traverse all of the project files, generate a binary file filetable.bin that contains all the file's checksums. layaPlayerAt startup, this file is obtained from the server（If you need it）determine what files need to be updated.

layadcc it can also be used to create a resource package that is used to pack the resources into App.

## type of LayaPlayer resource package
There are three current resource packaging solutions.
1. #### App networking package：  

   App itself does not have any resources,  and the volume is the smallest.
   LayaPlayer first run time, all the resources used will be downloaded from the server side, And cached in the local。Second and after operation, DCC file will be obtained from the server first, and then when you need to download a file, Check whether local resources need to be updated, Only when it needs to be updated is it really downloaded, Non-updated resources are read directly from the local cache
   Local caches will increase gradually.

2. #### Resource based App networking packages:

   App package itself contains some or all of the game resources, with a larger package.
   data can still be updated, i.e. each run will still take the DCC file from the server to check, if found a file in the package is old, it will download the new file in the local cache, then run again, as long as the cache file has not changed, we still use the cache. 
   After many updates, most of the files of the App package are invalid, and the local cache is always taken. At this time, it is recommended to renew the App package and package it with new resources.

3. #### App offline package (stand-alone package) :  

   All of the resources are packaged in App directly, without the need for network downloads, or even networking. The volume is the largest.
  Because it is a stand-alone version, no url, so can not be dynamically updated resources, you want to update the resource, you can only update the App.

## Install and use layadcc
layadcc based on Node.js, So you need a Node.js environment.
### 1. Install  Node.js 
Reach nodejs[official website](https://nodejs.org/en/) download.
node.js cant support too old version, under 0.xx, you can use the command to view the node version
for example :  
```bash
$ node -v
v4.2.0
```
This version is OK.

### 2. install layadcc
```bash
npm install -g layadcc
```
If you install it smoothly, you can execute layadcc directly on the command line.

### 3.Usage method

```
layadcc Resource catalog [options]
options:
    -cache Generate a resource package.
    -lwr All file paths are in lowercase.（Generally do not need）
    -url url If you want to package resources, Corresponding url.
    -cout outpath Packaging resources output directory, If not set up, it's under the resource directory.
for example:
   layadcc d:/game/wow -cache -url www.game.com
```
### 4. Actual operationn
#### 4.1 Operating environment
Make sure Node.js, npm, and layadcc are installed properly
Authentication method:  
![](img/2.png)  
Picture 1  
As long as the implementation of layadcc no error on it.

#### 4.2 html5 project environment
Suppose there is a game project, put contents under F:/work/test/bestgame/ (Start page index.html is in this directory), directory structure is：
![](img/3.png)  
Picture 2   
After the project is published, the corresponding URL address is： `http://www.layabox.com/bestgame/index.html`  
（If the single version does not need the URL address）

#### 4.3 Packaging resources
Now you have to pack the HTML5 project and put it in the App project.
```
 layadcc F:/work/test/bestgame -cache -url http://www.layabox.com/bestgame/index.html
```
If it is a single package, input:
```
 layadcc F:/work/test/bestgame -cache -url http://stand.alone.version/index.html
```

Following figure :  
![](img/2.gif)  
Picture 3  

After adding the `-cache` parameter, all the resource files will be traversed, Output to `-cout` specified directory, if there is not `-cout` Parameters, create a layadccout directory in the working directory（As shown above）, the cache directory in the output directory is the resource to be used when packaging the App.
Then you can copy this directory into the corresponding directory of the project that you build, and you can compile and pack the App.  
In different development environments, it needs to be placed in different directories（If you use the LayaAirIDE or layabox command line tools, This can be done automatically）.  

**Android Eclipse:**  
![1](img/1.jpg) <br />
（Picture 4） The resource directory of the Android is the assets directory under the project

**Android Studio:**  
![](img/5.png)  
（Picture 5）  

**iOS XCode:**  
![2](img/2.jpg) <br />
（Picture 6）IOS is the resource directory

#### 4.4 Update server
This is the most common operation after the release of App. Whenever updating the contents of the HTML5 project, we need to generate new DCC when we need to submit to the server or local test, so that the client can update to the latest resources. The operation process is as follows
Picture ：   
![](img/1.gif)  
Picture 7   

You can see that after the layadcc is executed, in the specified directory（Now is the current path）A update directory will be generated below. Then copy the update directory to the same directory in the local or remote server.
**Tips:**   
For convenience and no error, it is recommended to execute layadcc directly in the directory where the server is located.

**update Catalog introduction:**   
![](img/4.png)  
Picture 8  

allfiles.txt Relative path of all resource files.
assetsid.txt  dcc statistics of the entire resource package checksum.
filetable.bin dcc main file, which is the check value of each file.
filetable.txt Text format DCC files, with the exception of the first three lines, each row represents a file and the corresponding check value, And allfiles.txt exactly correspond, Line 4 corresponds to the file is the first line of allfiles.txt.
filetable1.txt This file is no longer used. 

**Be careful:**  
1. If there is no update directory on the web server directory, Or update directory there is no content, The client dcc update mechanism will be closed, So all the resources will be downloaded again. It is recommended to use this method during development.
2. The above example is in the current directory,in fact, you can specify other paths, relative or absolute, for example:
   `layadcc d:/game/bin/h5` or `layadcc ../bin/h5`


#### 4.5 test
1. Test for successful resource packaging
   First say that there is no resource in the package, in this case all the resources will be downloaded from the Internet，log is as follows:   
   ![](img/7.png)  
   Picture 9  Can see a lot of Download   
   **Print information instructions ：**  
    Inside the url followed by @127.0.0.1 is for debugging, Indicates the server address corresponding to this file. s=0Indicates that this file does not have dcc information,  l=xxx indicates the length of the downloaded file.

    If you hit a resource package, that is, the things under the cache directory are copied to the above specified directory, and the most intuitive change is that the package becomes larger. Then running app, there will be a print of the resource read from the resource package, as follows:
    ![](img/8.png)    
    Picture 10  
   **Print information description**  
   Print `found the file in the package:` It means that the corresponding resources are obtained from the package, No download to the network, seeing this log indicates the success of packaging resources. If you hit the stand-alone version, Then all resources should have this print, there should be no downloads.

2. Whether the service has a DCC test：  
   Open the address in a browser： http://www.layabox.com/bestgame/update/filetable.txt  
   Notice to change to your own address, if the file exists, it means to hit DCC. As follows:  
   ![](img/6.png)  
   Picture 11 

3. Update mechanism works for the test
   An intuitive test is to update the resources, App产生了对应的改变, App produces a corresponding change, Can see on app. From the log，It's time to get the resources, Those who have not changed are printed  `found the file in the package:`, And the change is all printed `Downlaod [ ] xxxurl `。   
   **Note**  
     1 The Download is only executed once, and second times into the app, and if the resource is not changed, it will be taken directly from the cache.
     2 The mechanism of DCC is the runtime update, so it will be downloaded only when the resource is needed, instead of downloading all updates as soon as it is started.


**summary**  
* All there is `Downlaod [ ] url ` That means download, no dcc or resource update
* All there is`found the file in the package:`, description package resources success, dcc work.


**Note :**  
* When layadcc is executed, the modification time of all files will be modified, the purpose is to prevent cdn in the back of the source that the file has not been modified.
* The above address is fictive, address does not exist http://www.layabox.com/bestgame/index.html 


## Common problem
1. After packing the resources, it doesn't feel fast, may caused by resources are still downloading.
    1. 确定是否真的都是在下载，看日志是不是有上面提到的Download和find，如果既有读缓存，也有下载，则没有问题，只是真的下载慢。
    2. 如果全部都是Download，没有读缓存  
        1. 是不是忘了打dcc了，通过浏览器检查服务器是否有dcc信息。
        2. 检查打包资源路径是否正确。

2. App发布后，修改了部分资源，但是没有被App更新到。  
    1. 是不是忘了打dcc了？
    2. 打了dcc了，但是忘了提交到服务器上（建议在服务器打dcc）？
    3. 打了dcc了，也提交到服务器了，但是由于有cdn，还没有把这个变化分发到你所在的节点。

3. 我确认dcc流程都对了，但是某个资源每次都会重新下载，不走缓存。
    1. 确认这个资源是否在打包资源中，即dcc列表中，可以在 update/allfiles.txt中搜索这个文件。
    2. 如果在。确认请求这个资源的url是否有search部分，即?xxx, 如果加了的话，是无法走dcc流程的。    
    3. 如果也没有search，那有可能是这个文件的实际内容与校验值不匹配，dcc会以为是错误的文件，就不缓存了。可能的原因：
        1. 打完dcc以后，有人把这个文件的内容又给改了，导致dcc校验值与实际文件内容不匹配。解决方法：重新打dcc
        2. 没人改文件内容，但是dcc是在客户端打的，文件在上传到服务器以后，被上传软件修改内容了。这种情况一般发生在文本文件上，例如有的版本管理工具和ftp工具会把windows下的回车换行变成unix的回车。解决方法：用zip的方式传文件，或者在服务器上打dcc。 
        3. 没有上面的问题，而且错误的是图片。可能原因是有的系统会全局截获http请求，在请求图片的时候，通过自己的服务器来缓存一个被压缩过的图片，来达到所谓的节省流量。这个压缩过的图片的校验值肯定与dcc记录的不一样。解决方法：关掉节省流量功能。
        4. 如果没有开流量节省。但是使用了cdn，则还可能是cdn的问题，例如dcc文件被刷新了，但是对应的资源文件没有刷新。确认方法：通过curl命令下载本节点上的资源文件（方法见附录），与源站的资源文件比较，如果不同，即确认。解决方法：强制刷新cdn节点，或者找cdn客服。

4. 开发期间，每次更新都打dcc太麻烦。  
    不要用layadcc来打dcc，如果已经打了，
    把update目录删掉，然后重新安装一下app，以去掉内部的缓存，这样dcc机制就关掉了，每个文件每次请求都会重新下载。  
    如果某次又打了一下dcc，在服务器端生成了update目录，则缓存又会起作用，想关掉的话，再来一遍上面的操作。

## Further more
1. Process of LayaDCC
   ![](img/1.png)  
   Picture 12  
   Corresponding code in index.js

2. Download a file on a CDN node.
```sh
curl -H "Host:www.layabox.com" http://182.110.238.110/bestgame/index.html >a.html
```
Representing the 182.110.238.110 node `http://www.layabox.com/bestgame/index.html`,  file is downloaded and saved to a.html
其中的 Host：后面的内容改成自己的域名， `http://`后面的ip地址改成节点服务器的地址，那怎么获得节点服务器地址呢？在LayaPlayer中，节点服务器通常不会改变，所以可以通过任意一个Download的打印来得到地址，例如:  
```
Downloaded http://www.layabox.com/bestgame/bestgame.min.js@182.110.238.110 s=44216b56 l=422
```
It is known that the node address is  182.110.238.110。 
